# 四元数 (Quaternion) 知识

四元数（Quaternion）是一种在计算机图形学、机器人学、航空航天等领域广泛用于表示三维空间旋转的数学工具。它由四个分量组成，通常写成 $q = w + xi + yj + zk$，其中 $w$ 是实部，$(x, y, z)$ 是虚部，而 $i, j, k$ 是满足特定乘法规则的虚数单位。

## 为什么使用四元数？

在理解四元数之前，我们先看看其他表示旋转的方法及其局限性：

### 1. 欧拉角 (Euler Angles)

*   **优点:** 直观，容易理解（例如：绕 X 轴旋转俯仰角、绕 Y 轴旋转滚转角、绕 Z 轴旋转偏航角）。
*   **缺点:**
    *   **万向锁 (Gimbal Lock):** 当两个旋转轴对齐时，会丢失一个自由度，导致无法通过改变其中一个角度来达到预期的旋转，或者有多种欧拉角组合表示同一旋转。
    *   **顺序依赖:** 旋转的最终结果取决于旋转轴的顺序（例如 X-Y-Z 和 Z-Y-X 顺序得到的结果不同）。
    *   **插值困难:** 在两个旋转之间进行平滑插值（例如动画）时，容易出现不自然的旋转路径。

### 2. 旋转矩阵 (Rotation Matrices)

*   **优点:** 易于对点和向量进行变换（矩阵乘法），可以方便地串联多个旋转（矩阵乘法）。
*   **缺点:**
    *   **冗余:** 用 9 个数字（3x3 矩阵）来表示 3 个自由度的旋转，效率较低。
    *   **数值误差:** 在多次乘法或浮点运算后，可能会积累误差导致矩阵不再是正交矩阵，需要定期进行“正交化”处理，这会带来额外的计算成本。
    *   **插值困难:** 对矩阵进行插值不像欧拉角那样简单。

### 四元数的优势:

*   **无万向锁:** 根本上避免了万向锁问题，能够表示任何三维旋转。
*   **紧凑:** 用 4 个数字表示旋转，比旋转矩阵更紧凑。
*   **高效:** 串联多个旋转（四元数乘法）比矩阵乘法计算量更小。
*   **平滑插值:** 提供了球形线性插值 (SLERP) 等方法，可以实现非常平滑和自然的旋转动画。
*   **数值稳定性:** 相比旋转矩阵，在浮点运算中更不容易积累误差。

## 四元数的基本概念

一个四元数 $q$ 可以表示为：
$$q = w + xi + yj + zk$$
或更常见的表示为：
$$q = (w, \vec{v})$$
其中 $w$ 是**实部**（或标量部分），$\vec{v} = (x, y, z)$ 是一个三维向量（**虚部**）。

### 1. 单位四元数 (Unit Quaternion)

*   只有**单位四元数**（模长为 1 的四元数，即 $||q|| = \sqrt{w^2 + x^2 + y^2 + z^2} = 1$）才能表示旋转。
*   非单位四元数除了表示旋转，还会引起缩放。在实际应用中，我们总是使用单位四元数来表示旋转，并定期对其进行归一化以消除浮点误差。

### 2. 恒等四元数 (Identity Quaternion)

*   $$q_{identity} = (1, 0, 0, 0)$$
*   表示**不进行任何旋转**。

### 3. 共轭四元数 (Conjugate)

*   如果 $q = (w, x, y, z)$，则其共轭为 $q^* = (w, -x, -y, -z)$。
*   在四元数运算中非常有用，尤其是计算逆。

### 4. 逆四元数 (Inverse)

*   $$q^{-1} = q^* / ||q||^2$$
*   对于**单位四元数**，由于 $||q||^2 = 1$，所以其逆就是其共轭：$q^{-1} = q^*$。
*   逆四元数表示与原四元数**方向相反的旋转**。

### 5. 归一化 (Normalization)

*   $$q_{normalized} = q / ||q||$$
*   将任意四元数转换为单位四元数。这是非常重要的步骤，用于在多次旋转后校正累积的浮点误差。

### 6. 四元数乘法 (Quaternion Multiplication / Hamilton Product)

*   这是将多个旋转串联起来的关键操作。
*   如果 $q_1 = (w_1, x_1, y_1, z_1)$ 和 $q_2 = (w_2, x_2, y_2, z_2)$，它们的乘积 $q_1 q_2$ 是一个更复杂的表达式，**但最重要的是，它不满足交换律，即 $q_1 q_2 \neq q_2 q_1$**。
*   **旋转串联:** 如果 $q_{current}$ 是当前的姿态四元数，而 $q_{delta}$ 是一个微小的旋转（通常是在**本地坐标系**中应用的旋转），那么新的姿态 $q_{new}$ 通常计算为：
    $$q_{new} = q_{current} \cdot q_{delta}$$
    这表示先应用 $q_{current}$ 的旋转，然后在其**局部坐标系**中应用 $q_{delta}$ 的旋转。

## 如何表示旋转 (轴-角表示)

四元数最直观的几何解释是它与**轴-角 (Axis-Angle)** 表示法的直接对应关系。

如果一个物体绕着单位向量轴 $\hat{n} = (n_x, n_y, n_z)$ 旋转了角度 $\theta$，那么对应的单位四元数是：

$$w = \cos(\theta / 2)$$
$$x = n_x \sin(\theta / 2)$$
$$y = n_y \sin(\theta / 2)$$
$$z = n_z \sin(\theta / 2)$$

## 如何用四元数旋转一个点/向量

要将一个三维向量 $\vec{P} = (p_x, p_y, p_z)$ 旋转，首先将其表示为一个纯虚四元数 $P = (0, p_x, p_y, p_z)$。
如果旋转由单位四元数 $q$ 表示，那么旋转后的向量 $P'$ 对应的纯虚四元数是：

$$P' = q \cdot P \cdot q^{-1}$$
对于单位四元数，由于 $q^{-1} = q^*$，则：
$$P' = q \cdot P \cdot q^*$$

## 四元数在 AirSim 中的应用

在 `FastPhysicsEngine` 中，四元数被用于表示无人机的姿态 (`Kinematics::State::pose::orientation`)，并通过以下步骤进行更新：

1.  **计算平均角速度 (`avg_angular`):** 这是在当前时间步内物体在**机体坐标系**下的平均旋转速度向量。

2.  **计算微小旋转的轴-角:**
    *   旋转轴就是 `avg_angular` 的单位向量。
    *   旋转角度是 `avg_angular` 的模长乘以时间步长 `dt`。
    *   对应的 `AngleAxisr` 构造函数：`AngleAxisr(angle_per_unit * dt_real, avg_angular / angle_per_unit)`。

3.  **将轴-角转换为四元数 (`angle_dt_q`):** 这个四元数表示物体在当前时间步内相对于其自身的微小旋转。

4.  **应用旋转:**
    ```cpp
    next.pose.orientation = current_pose.orientation * angle_dt_q;
    ```
    *   `current_pose.orientation` 是无人机当前的全局姿态。
    *   `angle_dt_q` 是在无人机**本地坐标系**中发生的微小旋转。
    *   四元数乘法自然地将这个本地旋转叠加到全局姿态上，得到新的全局姿态 `next.pose.orientation`。

5.  **归一化:**
    ```cpp
    next.pose.orientation.normalize();
    ```
    每次更新后都进行归一化，以防止数值误差累积。

这种方法确保了姿态更新的平滑性、准确性，并且避免了欧拉角可能导致的万向锁问题，这对于模拟无人机这种需要高精度姿态控制的载具至关重要。